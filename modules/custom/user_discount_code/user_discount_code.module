<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\BubbleableMetadata;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function user_discount_code_theme () {
  $theme['discountPage'] = [
    'variables' => [
    'titileDC' => NULL,
    'message' => NULL,
    ],
    'template' => 'user-discount-code',
  ];

  return $theme;
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function user_discount_code_user_insert (EntityInterface $entity) {

  $code = generateCode();

  $queryDisc = \Drupal::database()->insert('discount_code');
  $queryDisc->fields([
    'uid',
    'discount',
  ]);

  $queryDisc->values([
    $entity->id(),
    $code,
  ]);

  $queryDisc->execute();
}

function generateCode(){
  $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  $code = '';
  $max = mb_strlen($keyspace, '8bit') - 1;
  for ($i = 0; $i < 10; ++$i) {
    $code .= $keyspace[random_int(0, $max)];
  }

  $query = Drupal::database()->select('discount_code', 'discount_code');
  $query->addField('discount_code', 'discount');
  $codes = $query->execute()->fetchCol();

  foreach ($codes as $item){
    if($item == $code){
      return $code = generateCode();
    }
  }

  return $code;
}

/**
 * Implements hook_token_info().
 */
function user_discount_code_token_info () {
  $type = [
    'name' => t('Discount code'),
    'description' => t('Discount code token'),
  ];
  $discount['discount-code'] = [
    'name' => t('Discount code'),
    'description' => t('Discount code for user'),
  ];
  $username['username'] = [
    'name' => t('Username'),
    'description' => t('Username'),
  ];
  return [
    'types' => ['discount' => $type],
    'tokens' => [
      'discount' => [
        'discount-code' => $discount['discount-code'],
        'username' => $username['username'],]],
  ];
}

/**
 * Implements hook_tokens().
 */
function user_discount_code_tokens ($type, $tokens, array $data, array $options, BubbleableMetadata $bubbleable_metadata) {
  $replacements = [];
  $username = Drupal::currentUser()->getAccountName();
  $id = Drupal::currentUser()->id();

  $query = \Drupal::database()->select('discount_code', 'discount_code');
  $query->addField('discount_code', 'discount');
  $query->condition('discount_code.uid', $id);
  $code = $query->execute()->fetchField();

  foreach ($tokens as $name => $original) {
    switch ($name) {
      case 'discount-code':
        $replacements[$original] = $code;
        break;
      case 'username':
        $replacements[$original] = $username;
        break;
    }
  }
  return $replacements;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function user_discount_code_form_user_register_form_alter (&$form, FormStateInterface $form_state, $form_id) {
  $form['actions']['submit']['#submit'][] = 'user_discount_code_form_submit';
}

/**
 * Custom submit handler for login form.
 */
function user_discount_code_form_submit ($form, FormStateInterface $form_state) {
  $form_state->setRedirect('discount_code.content');
}